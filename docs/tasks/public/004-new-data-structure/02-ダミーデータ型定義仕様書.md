# BOM v2 データ構造仕様書

> バックエンドエンジニア向け - フロントエンドダミーデータから抽出した型定義と設計思想

## 設計思想の概要

本データ構造は「BizPM設計」に基づき、以下の3つの問題を解決しています。

### 1. 「固定」と「自由」の両立
- **Core（Item/ItemRev/BOM）** で基本構造をガチガチに管理
- **Facet** で属性を自由に拡張可能（スーパーテーブル問題の回避）

### 2. 「共通」と「個別」の両立
- Item（品番）は全社共通
- Context（視点）で工場・用途ごとに異なるBOMや調達先を表現

### 3. 「柔軟」と「速度」の両立
- FacetのJSONで柔軟性を確保
- FacetPropertyIndex（検索用索引）で検索性能を担保

---

## エンティティ一覧

| カテゴリ | エンティティ | 説明 |
|---------|-------------|------|
| Core | Item | 品番の器（不変の名札） |
| Core | ItemRev | 品番の版（BOMが参照する最小単位） |
| BOM | BOMHeader | 構成表の表紙（EBOM/MBOM区別） |
| BOM | BOMLine | 構成明細（親子関係と数量） |
| Facet | FacetType | 属性スキーマ（JSONスキーマ） |
| Facet | FacetInstance | 属性値（実際のデータ） |
| Document | DocumentType | 帳票種類（ユーザー定義可能） |
| Document | Document | 帳票（ItemRevに紐づく） |
| Document | Drawing | 図面（ItemRevに紐づく） |
| Task | Task | タスク（ItemRevに紐づく） |
| Comment | CommentThread | コメントスレッド |
| Comment | Comment | 個別コメント |

---

## Core エンティティ

### Item（品番の器）

Item は「これは何というモノか」を管理する不変の名札。設計変更があっても Item 自体は変わらない。

```typescript
interface Item {
  id: string;              // ULID形式
  partNumber: string;      // 品番（P/N） 例: "PRD-ARM-1000"
  name: string;            // 品名
  itemType: ItemType;      // アイテムタイプ
  lifecycleState: LifecycleState;  // ライフサイクル状態
  category?: string;       // カテゴリ分類
  description?: string;    // 説明
  createdAt: string;       // ISO 8601
  updatedAt: string;       // ISO 8601
}
```

#### ItemType（アイテムタイプ）

| 値 | 日本語名 | 説明 |
|----|---------|------|
| `Product` | 完成品 | 販売可能な最終製品 |
| `Assembly` | アセンブリ | 組立品（複数部品から構成） |
| `Part` | 製造部品 | 自社製造する部品 |
| `Purchased` | 購入品 | 外部から購入する部品 |
| `RawMaterial` | 原材料 | 板材、棒材などの素材 |

#### LifecycleState（ライフサイクル状態）

| 値 | 日本語名 | 説明 |
|----|---------|------|
| `Concept` | 構想段階 | アイデア・企画段階 |
| `Development` | 開発中 | 設計・試作段階 |
| `Production` | 量産中 | 製造・販売中 |
| `Discontinued` | 生産終了 | 新規生産停止 |
| `Obsolete` | 廃止 | 完全廃止 |

---

### ItemRev（品番の版）

ItemRev は Item の特定バージョン。BOM が参照する最小単位。

```typescript
interface ItemRev {
  id: string;              // ULID形式
  itemId: string;          // 親ItemのID（FK）
  revision: string;        // リビジョン記号 "A", "B", "C"...
  status: RevisionStatus;  // リビジョンステータス
  effectiveDate?: string;  // 有効開始日（ISO 8601）
  expirationDate?: string; // 有効終了日（ISO 8601）
  changeNote?: string;     // 変更理由
  facetInstanceIds: string[]; // 紐づくFacetInstanceのIDリスト
  createdAt: string;
  updatedAt: string;
}
```

#### RevisionStatus（リビジョンステータス）

| 値 | 日本語名 | 説明 |
|----|---------|------|
| `Draft` | 下書き | 編集中、未承認 |
| `InReview` | レビュー中 | 承認申請中 |
| `Released` | リリース済み | 承認済み、使用可能 |
| `Obsolete` | 廃止 | 旧版として使用不可 |

---

## BOM エンティティ

### BOMHeader（構成表の表紙）

1つの ItemRev に対して複数の BOMHeader を持てる（設計BOM、製造BOMなど）。

```typescript
interface BOMHeader {
  id: string;              // ULID形式
  parentItemRevId: string; // 親ItemRevのID（FK）
  bomType: BomType;        // BOM種別
  version: number;         // BOMバージョン（同じ親Revに複数可）
  status: RevisionStatus;  // BOMのステータス
  description?: string;    // BOM説明
  effectiveDate?: string;  // 有効開始日
  createdAt: string;
  updatedAt: string;
}
```

#### BomType（BOM種別）

| 値 | 日本語名 | 説明 |
|----|---------|------|
| `EBOM` | Engineering BOM | 設計BOM（機能的構成） |
| `MBOM` | Manufacturing BOM | 製造BOM（工程的構成） |

---

### BOMLine（構成明細）

レシピの1行。「どの子部品を、いくつ使うか」を定義。

```typescript
interface BOMLine {
  id: string;               // ULID形式
  bomHeaderId: string;      // 所属するBOMHeaderのID（FK）
  childItemRevId: string;   // 子ItemRevのID（FK）★ItemRevを指す（Itemではない）
  sequence: number;         // 表示順序
  quantity: number;         // 員数
  unit: string;             // 単位 "EA", "kg", "m" 等
  findNumber?: string;      // 照合番号（図面バルーン番号等）
  referenceDesignator?: string; // 参照識別子（電子部品のR1,C1等）
  notes?: string;           // 備考
  createdAt: string;
  updatedAt: string;
}
```

> **重要**: `childItemRevId` は `Item` ではなく `ItemRev` を参照する。
> これにより「どのバージョンの部品を使うか」が一意に決まる（Fixed Rev方式）。

---

## Facet エンティティ

### FacetType（属性スキーマ）

属性の「設計図」。どのような項目をどのような型で持つかを JSON Schema で定義。

```typescript
interface FacetType {
  id: string;              // ULID形式
  name: string;            // 属性タイプ名
  code: string;            // コード（一意識別子）
  category: FacetCategory; // 属性カテゴリ
  schema: FacetSchema;     // JSONスキーマ定義
  applicableItemTypes: ItemType[]; // 適用可能なItemType
  description?: string;
  createdAt: string;
  updatedAt: string;
}
```

#### FacetCategory（属性カテゴリ）

| 値 | 日本語名 | 説明 |
|----|---------|------|
| `Design` | 設計属性 | 材質・寸法・重量など |
| `Procurement` | 調達属性 | 仕入先・価格・リードタイムなど |
| `Manufacturing` | 製造属性 | 工程・設備・工数など |
| `Drawing` | 図面属性 | 作成者・承認者・規格など |
| `Document` | 帳票属性 | 作成者・有効期限・金額など |

#### FacetSchema（JSONスキーマ）

```typescript
interface FacetSchema {
  type: 'object';
  properties: Record<string, FacetSchemaProperty>;
  required?: string[];
}

interface FacetSchemaProperty {
  type: 'string' | 'number' | 'boolean' | 'array';
  title: string;           // 表示ラベル
  description?: string;
  enum?: (string | number)[]; // 選択肢
  default?: unknown;
  unit?: string;           // 単位（mm, kg等）
  minimum?: number;
  maximum?: number;
}
```

#### 定義済み FacetType 一覧

| ID | Code | カテゴリ | 説明 |
|----|------|---------|------|
| `FT-DESIGN-BASIC` | `DESIGN_BASIC` | Design | 基本設計属性（材質・重量・寸法） |
| `FT-DESIGN-ELEC` | `DESIGN_ELECTRICAL` | Design | 電気特性（電圧・電流・消費電力） |
| `FT-PROCUREMENT` | `PROCUREMENT` | Procurement | 調達属性（仕入先・価格・リードタイム） |
| `FT-MANUFACTURING` | `MANUFACTURING` | Manufacturing | 製造属性（工程・設備・工数） |
| `FT-DRAWING-META` | `DRAWING_META` | Drawing | 図面メタデータ |
| `FT-DOCUMENT-META` | `DOCUMENT_META` | Document | 帳票メタデータ |

---

### FacetInstance（属性値）

FacetType のスキーマに基づく実際の値。ItemRev、Drawing、Document に紐づく。

```typescript
interface FacetInstance {
  id: string;              // ULID形式
  facetTypeId: string;     // FacetTypeのID（FK）
  values: Record<string, unknown>; // 実際の値（スキーマに準拠）
  createdAt: string;
  updatedAt: string;
}
```

#### FacetInstance の例（基本設計属性）

```json
{
  "id": "FI-PRD-001-B-DESIGN",
  "facetTypeId": "FT-DESIGN-BASIC",
  "values": {
    "material": "アルミニウム合金",
    "weight": 125.5,
    "dimensions": "1200 x 800 x 1500",
    "surfaceTreatment": "粉体塗装",
    "color": "ホワイト"
  }
}
```

---

## Document エンティティ

### DocumentType（帳票種類）

ユーザー定義可能な帳票の種類マスタ。

```typescript
interface DocumentType {
  id: string;              // ULID形式
  code: string;            // 帳票種類コード 例: "QUOTE", "PO", "DN"
  name: string;            // 帳票種類名 例: "見積書", "発注書", "納品書"
  description?: string;
  numberPrefix: string;    // 帳票番号の採番プレフィックス
  createdAt: string;
  updatedAt: string;
}
```

---

### Drawing（図面）

ItemRev に紐づく図面。

```typescript
interface Drawing {
  id: string;              // ULID形式
  drawingNumber: string;   // 図面番号 例: "DWG-PRT-GER-001-B"
  title: string;           // 図面タイトル
  itemRevId: string;       // 紐づくItemRevのID（FK）
  drawingType: string;     // 図面タイプ "組立図", "部品図", "配線図"
  sheetSize: string;       // 図面サイズ "A1", "A2", "A3", "A4"
  sheetNumber: number;     // シート番号
  totalSheets: number;     // 総シート数
  s3Path?: string;         // S3パス（ファイル格納場所）
  facetInstanceIds: string[]; // 紐づくFacetInstanceのIDリスト
  createdAt: string;
  updatedAt: string;
}
```

---

### Document（帳票）

ItemRev に紐づく帳票（見積書、発注書など）。

```typescript
interface Document {
  id: string;              // ULID形式
  documentNumber: string;  // 帳票番号 例: "QT-2024-001"
  title: string;           // 帳票タイトル
  itemRevId: string;       // 紐づくItemRevのID（FK）
  documentTypeId: string;  // 帳票種類のID（FK）
  s3Path?: string;         // S3パス
  facetInstanceIds: string[]; // 紐づくFacetInstanceのIDリスト
  issueDate?: string;      // 発行日（ISO 8601）
  recipient?: string;      // 宛先（取引先名など）
  createdAt: string;
  updatedAt: string;
}
```

---

## Task エンティティ

### Task（タスク）

ItemRev やコメントに紐づくタスク。

```typescript
interface Task {
  id: string;
  title: string;
  description?: string;
  status: TaskStatus;      // "todo" | "in_progress" | "done"
  priority: TaskPriority;  // "high" | "medium" | "low"
  assignee?: TaskAssignee; // 担当者
  dueDate?: string;        // 期限（ISO 8601）
  createdAt: string;
  updatedAt?: string;
  targetObject?: TaskTargetObject;   // 対象ItemRev
  sourceComment?: TaskSourceComment; // 元コメント
  canvasPosition?: { x: number; y: number }; // キャンバス座標
}

interface TaskAssignee {
  id: string;
  name: string;
  avatarUrl?: string;
  department?: string;
}

interface TaskTargetObject {
  itemRevId: string;
  itemId: string;
  itemName: string;
  partNumber: string;
  itemType: ItemType;
}

interface TaskSourceComment {
  threadId: string;
  commentId: string;
  content: string;
  authorName: string;
}
```

---

## Comment エンティティ

### CommentThread & Comment

```typescript
interface Comment {
  id: string;
  content: string;
  authorId: string;        // ユーザーID（FK）
  createdAt: string;
  updatedAt?: string;
}

interface CommentThread {
  id: string;
  resolved: boolean;       // 解決済みフラグ
  comments: Comment[];     // スレッド内のコメント
  createdAt: string;
  canvasPosition?: { x: number; y: number }; // キャンバス座標
}
```

---

## エンティティ関連図（ER概要）

```
                              ┌─────────────────┐
                              │     Item        │
                              │   (品番の器)    │
                              └────────┬────────┘
                                       │ 1:N
                              ┌────────▼────────┐
          ┌───────────────────┤    ItemRev      │───────────────────┐
          │                   │   (品番の版)    │                   │
          │                   └────────┬────────┘                   │
          │                            │                             │
          │ 1:N                        │ 1:N                         │ 1:N
          ▼                            ▼                             ▼
   ┌──────────────┐           ┌──────────────┐              ┌──────────────┐
   │   Drawing    │           │  BOMHeader   │              │   Document   │
   │    (図面)    │           │ (構成表表紙) │              │    (帳票)    │
   └──────────────┘           └──────┬───────┘              └──────────────┘
                                     │ 1:N
                              ┌──────▼───────┐
                              │   BOMLine    │
                              │  (構成明細)  │──────▶ ItemRev (子)
                              └──────────────┘

   ┌──────────────────────────────────────────────────────────────────┐
   │                        Facet システム                            │
   │                                                                  │
   │  ┌─────────────┐                ┌─────────────────┐              │
   │  │  FacetType  │  1:N           │  FacetInstance  │              │
   │  │ (スキーマ)  │◀───────────────│   (属性値)      │              │
   │  └─────────────┘                └────────┬────────┘              │
   │                                          │                       │
   │                    ┌─────────────────────┼────────────┐          │
   │                    ▼                     ▼            ▼          │
   │              ItemRev.facetInstanceIds  Drawing    Document       │
   └──────────────────────────────────────────────────────────────────┘
```

---

## 品番体系（ダミーデータで使用）

| プレフィックス | ItemType | 例 |
|---------------|----------|-----|
| `PRD-xxx` | Product | `PRD-ARM-1000` (産業用ロボットアーム) |
| `ASY-xxx` | Assembly | `ASY-BASE-100` (ベースユニット) |
| `PRT-xxx` | Part | `PRT-GER-001` (ギアボックス) |
| `PUR-xxx` | Purchased | `PUR-MTR-001` (ACサーボモーター) |
| `RAW-xxx` | RawMaterial | `RAW-ALM-001` (アルミ板材) |

---

## API設計時の考慮点

### 1. BOM展開（Explosion）

親ItemRevから全子孫を再帰的に取得するクエリが必要。

```
GET /api/bom/explode/{itemRevId}?depth=3
```

### 2. Where-Used検索

指定したItemRevがどこで使われているかを検索。

```
GET /api/bom/where-used/{itemRevId}
```

### 3. Facet の動的検索

FacetPropertyIndex テーブルを用いた高速検索。

```
GET /api/items/search?facet.material=アルミニウム合金&facet.weight_gte=100
```

### 4. Context による絞り込み

同一ItemRevに対して工場・用途別のBOM/調達先を取得。

```
GET /api/bom/{itemRevId}?context=PLANT_KYOTO
GET /api/bom/{itemRevId}?context=PLANT_US
```

---

## 付録: 詳細スキーマ定義

### DESIGN_BASIC（基本設計属性）

| プロパティ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `material` | string (enum) | Yes | 材質 |
| `weight` | number | No | 重量 (kg) |
| `dimensions` | string | No | 寸法 W x D x H (mm) |
| `surfaceTreatment` | string (enum) | No | 表面処理 |
| `toleranceClass` | string (enum) | No | 公差等級 (IT5〜IT12) |
| `color` | string | No | 色 |

### PROCUREMENT（調達属性）

| プロパティ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `supplierName` | string | Yes | 仕入先名 |
| `supplierCode` | string | No | 仕入先コード |
| `supplierPartNumber` | string | No | 仕入先品番 |
| `unitPrice` | number | Yes | 単価 (円) |
| `currency` | string (enum) | No | 通貨 (JPY/USD/EUR/CNY) |
| `moq` | number | No | 最小発注数量 |
| `leadTimeDays` | number | No | リードタイム (日) |
| `procurementType` | string (enum) | No | 調達区分 (内製/外注/購入) |
| `alternateSupplier` | string | No | 代替サプライヤー |

### MANUFACTURING（製造属性）

| プロパティ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `processName` | string (enum) | No | 工程名 |
| `workCenter` | string | No | ワークセンター |
| `standardTime` | number | No | 標準工数 (分) |
| `setupTime` | number | No | 段取時間 (分) |
| `equipmentRequired` | string | No | 必要設備 |
| `manufacturingLocation` | string (enum) | No | 製造拠点 |
| `lotSize` | number | No | 標準ロットサイズ |

---

**ドキュメント作成日**: 2025-01-09
**参照ソース**: `frontend/src/shared/dummy-data/bom-v2/`
