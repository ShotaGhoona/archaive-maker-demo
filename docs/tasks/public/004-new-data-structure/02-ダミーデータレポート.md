# BOM v2 ダミーデータ作成レポート

## 概要

BizPM設計に基づく新しいデータ構造でBOM管理システムのダミーデータを作成しました。
UI互換用の型・関数は全て削除し、純粋なデータ構造のみを提供しています。

### 設計思想（BizPM 7章より）

1. **Core（骨格）は最小限に**: ItemとItemRevは「IDと履歴」のみ。属性はFacetへ
2. **BOM構造は単階層**: BOMLineは親→子の1階層のみ保存。多階層は再帰解決
3. **属性はFacetで柔軟に**: スーパーテーブル問題を回避。部門ごとに独立管理

### 旧構造からの変更点

| 項目 | 旧構造 | 新構造 |
|------|--------|--------|
| データ形式 | 単一JSON（15,389行） | TypeScript分割ファイル |
| 構造 | ネストされたツリー | リレーショナル（正規化） |
| 品番管理 | なし | Item/ItemRev分離 |
| BOM表現 | 再帰的子配列 | BOMHeader + BOMLine |
| 属性管理 | 固定フィールド | Facetによる柔軟な拡張 |
| UI互換 | あり | **削除**（UIは新規構築） |

---

## データ構造（ER図）

```
┌─────────────────────────────────────────────────────────────────────┐
│                    BizPM BOM Architecture                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐                                                   │
│  │     Item     │  品番の器（P/N）- 不変のID                         │
│  │  (Core)      │  pn, name, lifecycle_state                        │
│  └──────┬───────┘                                                   │
│         │ 1:N                                                       │
│         ▼                                                           │
│  ┌──────────────┐      1:N      ┌──────────────┐                    │
│  │   ItemRev    │──────────────▶│  BOMHeader   │                    │
│  │  (Core)      │               │ (Structure)  │                    │
│  │  rev, status │               │ bom_type     │                    │
│  └──────┬───────┘               │ (EBOM/MBOM)  │                    │
│         │                       └──────┬───────┘                    │
│         │ N:M                          │ 1:N                        │
│         ▼                              ▼                            │
│  ┌──────────────┐               ┌──────────────┐                    │
│  │FacetInstance │               │   BOMLine    │──▶ ItemRev (子)    │
│  │  (Facet)     │               │ (Structure)  │                    │
│  │  values_json │               │  qty, find#  │                    │
│  └──────┬───────┘               └──────────────┘                    │
│         │ N:1                                                       │
│         ▼                                                           │
│  ┌──────────────┐                                                   │
│  │  FacetType   │  属性スキーマ（JSONスキーマ）                       │
│  │  (Facet)     │  設計/調達/製造カテゴリ                            │
│  └──────────────┘                                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### エンティティ説明

| レイヤー | エンティティ | 役割 | BizPM参照 |
|---------|-------------|------|-----------|
| Core | Item | 品番の器（P/Nの不変ID） | 第1章 |
| Core | ItemRev | 品番の版（BOM参照の最小単位） | 第1章 |
| Structure | BOMHeader | 構成表の表紙（EBOM/MBOM区別） | 第2章 |
| Structure | BOMLine | 構成明細（子ItemRevと数量） | 第2章 |
| Facet | FacetType | 属性スキーマ（JSONスキーマ） | 第3章 |
| Facet | FacetInstance | 属性値（values: JSON） | 第3章 |

---

## 作成ファイル一覧

```
frontend/src/shared/dummy-data/bom-v2/
├── types.ts                    # 型定義（Core/Structure/Facetのみ）
├── index.ts                    # エクスポート＆クエリ関数
├── item/
│   └── items.ts                # Itemダミーデータ（45件）
├── item-rev/
│   └── item-revs.ts            # ItemRevダミーデータ（58件）
├── bom/
│   ├── bom-headers.ts          # BOMHeaderダミーデータ（14件）
│   └── bom-lines.ts            # BOMLineダミーデータ（79件）
└── facet/
    ├── facet-types.ts          # FacetType定義（4件）
    └── facet-instances.ts      # FacetInstanceダミーデータ（約100件）
```

---

## データ統計

| エンティティ | 件数 | 説明 |
|-------------|------|------|
| Item | 45件 | 品番マスタ |
| ItemRev | 58件 | リビジョン（一部は複数Rev） |
| BOMHeader | 14件 | EBOMのみ |
| BOMLine | 79件 | 親子関係 |
| FacetType | 4件 | 属性スキーマ |
| FacetInstance | 約100件 | 属性値 |

### Item内訳

| ItemType | 件数 | プレフィックス | 説明 |
|----------|------|---------------|------|
| Product | 1件 | PRD- | 完成品 |
| Assembly | 13件 | ASY- | アセンブリ |
| Part | 10件 | PRT- | 製造部品 |
| Purchased | 18件 | PUR- | 購入品 |
| RawMaterial | 3件 | RAW- | 原材料 |

---

## 製品構成（産業用ロボットアーム ARM-1000）

```
PRD-ARM-1000 [Product] 産業用ロボットアーム
├── ASY-BASE-100 [Assembly] ベースユニット
│   ├── ASY-DRV-110 [Assembly] 駆動システム
│   │   ├── PUR-MTR-001 [Purchased] サーボモーター 200W (x2)
│   │   ├── PRT-GER-001 [Part] 減速ギア RG-50 (x2)
│   │   ├── PUR-ENC-001 [Purchased] エンコーダ (x2)
│   │   └── PRT-HSG-001 [Part] ハウジング
│   ├── ASY-FRM-120 [Assembly] フレーム構造
│   │   ├── PRT-PLT-001 [Part] ベースプレート
│   │   ├── PRT-COL-001 [Part] 支柱 (x4)
│   │   ├── PUR-BLT-001 [Purchased] ボルトM8x25 (x20)
│   │   ├── PUR-NUT-001 [Purchased] ナットM8 (x20)
│   │   └── RAW-ALM-001 [RawMaterial] アルミニウム合金板
│   └── ASY-CTL-130 [Assembly] 制御ボード
│       ├── PRT-PCB-001 [Part] 制御基板
│       ├── PUR-CPU-001 [Purchased] マイコン STM32
│       ├── PUR-DRV-001 [Purchased] モータードライバIC (x6)
│       ├── PUR-CAP-001 [Purchased] コンデンサ (x20)
│       ├── PUR-RES-001 [Purchased] 抵抗 (x30)
│       └── PUR-CON-001 [Purchased] コネクタ (x8)
├── ASY-ARM-200 [Assembly] アームユニット
│   ├── ASY-J1-210 [Assembly] 第1関節（肩）
│   ├── ASY-J2-220 [Assembly] 第2関節（肘）
│   ├── ASY-J3-230 [Assembly] 第3関節（手首）
│   └── ASY-LNK-240 [Assembly] リンク機構 (x2)
├── ASY-END-300 [Assembly] エンドエフェクター
│   ├── ASY-GRP-310 [Assembly] グリッパー機構
│   └── ASY-SNS-320 [Assembly] センサーユニット
├── ASY-PWR-400 [Assembly] 電源ユニット
└── PUR-CBL-001 [Purchased] ケーブルハーネス
```

---

## FacetType定義

### 1. DESIGN_BASIC（基本設計属性）

| プロパティ | 型 | 説明 | 単位 |
|-----------|-----|------|------|
| material | string | 材質 | - |
| weight | number | 重量 | kg |
| dimensions | string | 外形寸法 | mm |
| surfaceTreatment | string | 表面処理 | - |
| color | string | 色 | - |

適用対象: Product, Assembly, Part

### 2. DESIGN_ELECTRICAL（電気設計属性）

| プロパティ | 型 | 説明 | 単位 |
|-----------|-----|------|------|
| ratedVoltage | number | 定格電圧 | V |
| ratedCurrent | number | 定格電流 | A |
| powerConsumption | number | 消費電力 | W |
| protectionClass | string | 保護等級 | - |

適用対象: Assembly, Purchased

### 3. PROCUREMENT（調達属性）

| プロパティ | 型 | 説明 | 単位 |
|-----------|-----|------|------|
| supplierName | string | 仕入先名 | - |
| supplierPartNumber | string | 仕入先品番 | - |
| unitPrice | number | 単価 | 円 |
| moq | number | 最小発注数量 | - |
| leadTimeDays | number | リードタイム | 日 |
| countryOfOrigin | string | 原産国 | - |

適用対象: Part, Purchased, RawMaterial

### 4. MANUFACTURING（製造属性）

| プロパティ | 型 | 説明 | 単位 |
|-----------|-----|------|------|
| processName | string | 工程名 | - |
| workCenter | string | ワークセンター | - |
| standardTime | number | 標準工数 | 分 |
| setupTime | number | 段取時間 | 分 |
| specialTools | array | 専用工具 | - |

適用対象: Product, Assembly, Part

---

## 提供API（クエリ関数）

### 基本検索

```typescript
// ID検索
getItemById(id: string): Item | undefined
getItemRevById(id: string): ItemRev | undefined
getBomHeaderById(id: string): BOMHeader | undefined
getBomLineById(id: string): BOMLine | undefined
getFacetTypeById(id: string): FacetType | undefined
getFacetInstanceById(id: string): FacetInstance | undefined

// 品番検索
getItemByPartNumber(partNumber: string): Item | undefined

// タイプ別フィルタ
getItemsByType(type: ItemType): Item[]
getItemsByLifecycle(state: LifecycleState): Item[]
getBomHeadersByType(type: BomType): BOMHeader[]
getFacetTypesByCategory(category: FacetCategory): FacetType[]
```

### 関連検索

```typescript
// Item → ItemRev
getItemRevsByItemId(itemId: string): ItemRev[]
getLatestReleasedRev(itemId: string): ItemRev | undefined
getItemRevsByStatus(status: RevisionStatus): ItemRev[]

// ItemRev → BOM
getBomHeadersByItemRev(itemRevId: string): BOMHeader[]
getBomLinesByHeader(headerId: string): BOMLine[]
getBomLinesByChildRev(childItemRevId: string): BOMLine[]

// ItemRev → Facet
getFacetInstancesByItemRev(itemRevId: string): FacetInstance[]
getFacetInstancesByType(facetTypeId: string): FacetInstance[]
```

### BOM操作

```typescript
// BOM展開（Explosion）- Multi-Level
explodeBom(parentItemRevId: string, depth?: number): Array<{
  level: number;
  parentItemRevId: string;
  childItemRevId: string;
  childItem: Item;
  childItemRev: ItemRev;
  quantity: number;
  bomLine: BOMLine;
}>

// 逆展開（Where-Used）
findWhereUsed(itemRevId: string): Array<{
  parentItemRev: ItemRev;
  parentItem: Item;
  bomLine: BOMLine;
  quantity: number;
}>

// 統計
getStatistics(): {
  itemCount: number;
  itemRevCount: number;
  bomHeaderCount: number;
  bomLineCount: number;
  facetTypeCount: number;
  facetInstanceCount: number;
}
```

---

## 使用例

### BOM展開（Multi-Level）

```typescript
import { explodeBom, getItemById } from '@/shared/dummy-data/bom-v2';

// 製品のBOMを全階層展開
const explosion = explodeBom('REV-PRD-001-B');

explosion.forEach(row => {
  const indent = '  '.repeat(row.level);
  console.log(`${indent}L${row.level}: ${row.childItem.partNumber} x${row.quantity}`);
});
// L1: ASY-BASE-100 x1
//   L2: ASY-DRV-110 x1
//     L3: PUR-MTR-001 x2
//     L3: PRT-GER-001 x2
// ...
```

### Where-Used検索

```typescript
import { findWhereUsed, getItemById, getItemRevById } from '@/shared/dummy-data/bom-v2';

// 減速ギアがどこで使われているか
const usages = findWhereUsed('REV-PRT-001-B');

usages.forEach(usage => {
  console.log(`${usage.parentItem.partNumber} で ${usage.quantity}個使用`);
});
// ASY-DRV-110 で 2個使用
// ASY-J1-210 で 1個使用
// ASY-J2-220 で 1個使用
// ASY-J3-230 で 1個使用
```

### Facet取得

```typescript
import { getFacetInstancesByItemRev, getFacetTypeById } from '@/shared/dummy-data/bom-v2';

// ItemRevの属性を取得
const facets = getFacetInstancesByItemRev('REV-PRT-001-B');

facets.forEach(fi => {
  const ft = getFacetTypeById(fi.facetTypeId);
  console.log(`[${ft?.code}]`, fi.values);
});
// [DESIGN_BASIC] { material: "S45C", weight: 0.8, ... }
// [PROCUREMENT] { supplierName: "精密加工社", unitPrice: 12000, ... }
```

---

## テストページ

データ構造の全貌を確認できるテストページを用意しています。

**URL:** `/test/bom-v2`

### 機能

| タブ | 内容 |
|-----|------|
| データ構造 | ER図、統計、Item内訳 |
| Item | 全Itemテーブル（クリックで詳細JSON） |
| ItemRev | 全ItemRevテーブル（Facet紐付き確認） |
| BOMHeader | 全BOMHeaderテーブル |
| BOMLine | 全BOMLineテーブル |
| FacetType | スキーマ定義詳細 |
| FacetInstance | 全属性値（JSON表示） |
| BOM展開 | Multi-Level展開（親選択可） |
| Where-Used | 逆展開検索 |
| JSON | 全データJSON出力 |

---

## 削除した旧UI互換機能

以下はBizPM設計に基づき**削除**しました。UIは新規構築します。

### 削除した型
- `NodeType` - 旧UIのノードタイプ
- `GalleryItemType` - 旧UIのアイテムタイプ
- `TreeNode` - 旧UIのツリーノード
- `Product` - 旧UIの製品型
- `BomNodeDetail` - 旧UIの詳細型

### 削除した関数
- `itemTypeToNodeType()` - 型変換
- `getProducts()` - 製品一覧（旧UI用）
- `buildBomTree()` - ツリー構築（旧UI用）
- `getBomTreeByProductId()` - 製品別ツリー（旧UI用）
- `getNodeDetailById()` - ノード詳細（旧UI用）

---

## 今後の拡張

### BizPM設計に基づく拡張ポイント

| 機能 | BizPM参照 | 説明 |
|------|-----------|------|
| Context | 第4章 | 視点切替（設計/製造/工場別） |
| Effectivity | 第4章 | 有効性（日付/シリアル/仕様） |
| SourcingPolicy | 第5章 | 調達方針（工場別仕入先） |
| ProcessPlan | 第5章 | 製造工程（BOP） |
| FacetPropertyIndex | 第6章 | 検索用インデックス |

### 具体的なTODO

1. **MBOM対応**: BOMHeader.bomType='MBOM'の追加
2. **Context実装**: 工場別・部門別の視点切替
3. **Effectivity実装**: 日付範囲による有効性管理
4. **ECN連携**: ItemRev.changeNote → 正式な変更管理
5. **Attachment**: ドキュメント/図面の紐付け

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-01-07 | 初版作成 |
| 2025-01-07 | UI互換機能を削除、BizPM設計準拠に修正 |
